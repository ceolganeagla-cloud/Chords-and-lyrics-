<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ceol Gan Eagla — Pro Tuner</title>
<meta name="theme-color" content="#0b121a">
<!-- © 2025 Gearóid MacUaid — Ceol Gan Eagla. All code & visuals are original. -->
<style>
:root{
  --bg:#0b121a; --ink:#eaf2ff; --muted:#9fb0c5;
  --surface:#0f1826; --panel:#0e1623; --line:#1a2a3e;
  --accent:#2fe17d; --accent-d:#1e9e56; --warn:#ff5858; --low:#62b6ff;
  --gold:#f6d889;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}

/* Layout */
.app{
  height:100dvh; max-width:1200px; margin:0 auto; padding:12px;
  display:grid; gap:12px; grid-template-rows:60px 1fr 36px;
}
header{display:flex;align-items:center;gap:12px}
.flag{
  width:38px;height:24px;border-radius:4px;border:1px solid #0006;
  background:linear-gradient(90deg,#169b62 0 33.33%,#fff 33.33% 66.66%,#ff883e 66.66% 100%);
  box-shadow:0 0 0 1px #0002 inset
}
.brand{font-size:20px;font-weight:900;letter-spacing:.3px}
.badge{background:var(--panel);border:1px solid var(--line);border-radius:999px;color:var(--muted);padding:6px 10px;font-size:12px}
.dot{width:10px;height:10px;border-radius:50%;background:#303a4c}
.dot.live{background:#ff5858;box-shadow:0 0 10px #ff585888}

/* Main area: left info rail + right dial */
.main{
  display:grid; grid-template-columns:340px 1fr; gap:12px; min-height:0;
}
@media (max-width:900px){ .main{grid-template-columns:1fr} }

/* Left rail */
.rail{
  display:grid; gap:12px; min-height:0;
}
.card{
  background:var(--surface); border:1px solid var(--line); border-radius:14px; padding:12px;
}
.card h3{margin:0 0 8px 0; font-size:14px; color:var(--muted); font-weight:700; letter-spacing:.2px}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
select,input[type=number],button{
  width:100%; background:#0c1320; color:var(--ink);
  border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:14px;
}
button{cursor:pointer; background:linear-gradient(180deg,#18263a,#0d1728); font-weight:800}
button:active{transform:translateY(1px)}
.btnStop{background:linear-gradient(180deg,#3a1d1d,#24110e)}

/* Status tiles */
.tile{
  background:linear-gradient(180deg,#0f1b2b,#0c1421);
  border:1px solid var(--line); border-radius:12px; padding:10px; display:grid; gap:8px;
}
.kv{display:flex; align-items:center; justify-content:space-between; gap:8px}
.big{
  font-size:40px; font-weight:900; letter-spacing:.4px; line-height:1;
  background:#173222; color:#bff6d6; border:1px solid #295a42; border-radius:10px; padding:8px 10px; text-align:center;
}
.stat{display:flex; gap:8px; flex-wrap:wrap}
.pill{border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:#0c1320; font-weight:800}
.state{border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-weight:900}
.state.low{background:#102033; color:#7ec8ff}
.state.high{background:#2a1616; color:#ff9a9a}
.state.ok{background:#123222; color:#b9f7d2; box-shadow:0 0 0 2px #2b5e4530 inset}

/* Right: dial */
.dialWrap{
  position:relative; min-height:0; background:var(--surface);
  border:1px solid var(--line); border-radius:18px; padding:10px; display:grid; grid-template-rows:24px 1fr 64px; gap:8px;
}
.dTop{display:flex; align-items:center; justify-content:space-between; gap:8px}
.rmsbar{width:140px; height:8px; background:#213347; border:1px solid var(--line); border-radius:999px; overflow:hidden}
.rmsbar>i{display:block; height:100%; width:0; background:#61d6ff}
canvas#dial{width:100%; height:100%}

/* Overlay IN TUNE */
.overlay{
  position:absolute; inset:34px 10px 96px 10px; display:flex; align-items:center; justify-content:center; pointer-events:none;
}
#inTune{
  display:none; font-weight:900; font-size:clamp(28px, 9vw, 60px);
  color:#0b121a; background:var(--accent); padding:.2em .6em; border-radius:14px;
  box-shadow:0 0 0 2px #2b5e45aa, 0 0 42px #2be07c55; border:1px solid #2b5e45
}

/* Footer */
footer{display:flex; align-items:center; justify-content:space-between; gap:8px; color:var(--muted); font-size:12px}
</style>
</head>
<body>
<div class="app">
  <header>
    <span class="flag" title="Éire"></span>
    <div class="brand">Ceol Gan Eagla — Pro Tuner</div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:10px">
      <span class="badge">Mic: <span id="micState">OFF</span></span>
      <div id="live" class="dot" aria-hidden="true"></div>
    </div>
  </header>

  <section class="main">
    <!-- Left rail -->
    <aside class="rail">
      <div class="card">
        <h3>Instrument & Tuning</h3>
        <div class="grid2">
          <select id="inst"></select>
          <select id="string"></select>
        </div>
      </div>

      <div class="card">
        <h3>Reference & Mic</h3>
        <div class="grid2" style="margin-bottom:10px">
          <select id="a4">
            <option>436</option><option>438</option><option>439</option>
            <option selected>440</option><option>441</option><option>442</option><option>444</option>
          </select>
          <select id="gate">
            <option value="0.002" selected>Gate: Very High</option>
            <option value="0.005">Gate: High</option>
            <option value="0.010">Gate: Medium</option>
            <option value="0.020">Gate: Low</option>
          </select>
        </div>
        <div class="grid2">
          <button id="micBtn">Start Mic</button>
          <button class="btnStop" id="stopAll">Stop All</button>
        </div>
      </div>

      <div class="tile">
        <div class="kv"><span class="badge">Detected</span><span id="detected" class="badge">—</span></div>
        <div id="noteBig" class="big">—</div>
        <div class="stat">
          <span class="pill">A4=<span id="a4v">440</span>Hz</span>
          <span class="pill">Freq: <span id="freq">—</span> Hz</span>
          <span class="pill">Δ: <span id="cents">—</span> ¢</span>
          <span class="pill">Target: <span id="target">—</span></span>
        </div>
        <div id="state" class="state">—</div>
      </div>

      <div class="card">
        <h3>Metronome</h3>
        <div class="grid2" style="margin-bottom:10px">
          <input id="bpm" type="number" min="20" max="240" value="120"/>
          <select id="sig">
            <option>2/4</option><option>3/4</option><option selected>4/4</option>
            <option>6/8</option><option>9/8</option><option>12/8</option>
          </select>
        </div>
        <button id="metroBtn">Start</button>
      </div>
    </aside>

    <!-- Right: dial -->
    <section class="dialWrap">
      <div class="dTop">
        <span class="badge">RMS: <span id="rms">0.000</span></span>
        <div class="rmsbar" title="Live level"><i id="rmsFill"></i></div>
        <span id="noInput" class="badge" style="display:none;background:#2a1616;color:#ffb1b1">No input</span>
      </div>
      <div style="position:relative;min-height:0">
        <canvas id="dial"></canvas>
        <div class="overlay"><div id="inTune">IN&nbsp;TUNE</div></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:center;gap:10px;color:var(--muted);font-size:13px">
        <span>Right = sharp, Left = flat • Perfect window: ±5¢</span>
      </div>
    </section>
  </section>

  <footer>
    <div>© <span id="y"></span> Gearóid MacUaid — Ceol Gan Eagla. All Rights Reserved.</div>
    <div>Replace <code>icons/icon-192.png</code> in your PWA build if needed.</div>
  </footer>
</div>

<script>
/* ===================== CONFIG ===================== */
// Keep this at -1 if it fixed the “going down” issue on your device
const DIRECTION = -1;
// Perfect window (± cents) and stability
const PERFECT_THRESHOLD = 5;
const PERFECT_HOLD_FRAMES = 8;

/* ===================== MUSIC MATH ===================== */
const N=["C","C♯","D","E♭","E","F","F♯","G","A♭","A","B♭","B"], A4I=9+12*4;
const idxToFreq=(i,a4)=>a4*Math.pow(2,(i-A4I)/12);
const freqToIdx=(f,a4)=>Math.round(12*Math.log2(f/a4)+A4I);
const nameFromIdx=i=>N[(i%12+12)%12]+(Math.floor(i/12)-1);
const centsOff=(f,t)=>1200*Math.log2(f/t);
const $=s=>document.querySelector(s);

const els={
  inst:$("#inst"), string:$("#string"),
  a4:$("#a4"), a4v:$("#a4v"), gate:$("#gate"),
  micBtn:$("#micBtn"), stopAll:$("#stopAll"), live:$("#live"), micState:$("#micState"),
  dial:$("#dial"), inTune:$("#inTune"), noteBig:$("#noteBig"),
  freq:$("#freq"), cents:$("#cents"), target:$("#target"),
  detected:$("#detected"), state:$("#state"),
  rms:$("#rms"), rmsFill:$("#rmsFill"), noInput:$("#noInput"),
  bpm:$("#bpm"), sig:$("#sig"), metroBtn:$("#metroBtn")
};
document.getElementById("y").textContent=new Date().getFullYear();
els.a4v.textContent=els.a4.value;

/* ===================== TUNINGS ===================== */
const TUNINGS={
  "Chromatic (no target)":[],
  "Violin — GDAE (G3 D4 A4 E5)":["G3","D4","A4","E5"],
  "Mandolin — GDAE (G3 D4 A4 E5)":["G3","D4","A4","E5"],
  "Tenor Banjo — Irish (G2 D3 A3 E4)":["G2","D3","A3","E4"],
  "Tenor Banjo — CGDA (C3 G3 D4 A4)":["C3","G3","D4","A4"],
  "Guitar — Standard (E2 A2 D3 G3 B3 E4)":["E2","A2","D3","G3","B3","E4"],
  "Guitar — DADGAD (D2 A2 D3 G3 A3 D4)":["D2","A2","D3","G3","A3","D4"],
  "Guitar — Open G (D2 G2 D3 G3 B3 D4)":["D2","G2","D3","G3","B3","D4"],
  "Bouzouki — GDAD (G2 D3 A3 D4)":["G2","D3","A3","D4"],
  "Bouzouki — ADAD (A2 D3 A3 D4)":["A2","D3","A3","D4"],
  "Whistle — D (D5)":["D5"]
};
function parseNote(n){
  const m=n.replace("♯","#").replace("♭","b").match(/^([A-Ga-g])([#b]?)(-?\d+)$/);
  const map={C:0,"C#":1,"Db":1,D:2,"D#":3,"Eb":3,E:4,F:5,"F#":6,"Gb":6,G:7,"G#":8,"Ab":8,A:9,"A#":10,"Bb":10,B:11};
  return map[m[1].toUpperCase()+(m[2]||"")] + 12*(parseInt(m[3],10)+1);
}
for(const k of Object.keys(TUNINGS)){ const o=document.createElement("option"); o.value=k; o.textContent=k; els.inst.appendChild(o); }
els.inst.value="Violin — GDAE (G3 D4 A4 E5)";
function refreshStrings(){
  els.string.innerHTML="";
  const set=TUNINGS[els.inst.value]||[];
  if(!set.length){ els.string.disabled=true; els.target.textContent="—"; }
  else{
    els.string.disabled=false;
    set.forEach((n,i)=>{ const o=document.createElement("option"); o.value=parseNote(n); o.textContent=`String ${i+1} — ${n}`; els.string.appendChild(o); });
    els.string.selectedIndex=set.length-1;
  }
}
refreshStrings();
els.inst.addEventListener("change", refreshStrings);
els.a4.addEventListener("change", ()=> els.a4v.textContent=els.a4.value);

/* ===================== DIAL RENDERING (HiDPI) ===================== */
const ctx = els.dial.getContext('2d');
ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
let cssW=0, cssH=0;  // CSS pixel space
function resizeDial(){
  const dpr=Math.max(1,window.devicePixelRatio||1);
  const r=els.dial.getBoundingClientRect();
  cssW=r.width; cssH=r.height;
  els.dial.width=Math.round(cssW*dpr);
  els.dial.height=Math.round(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS px
  drawFace(); drawNeedle(false);
}
window.addEventListener('resize', resizeDial);

let dispAngle=0, targAngle=0, easing=0.14, inTune=false;
function drawFace(){
  const cx=cssW/2, cy=cssH*0.9, r=cssH*0.84;
  ctx.clearRect(0,0,cssW,cssH);

  // background face
  const face=ctx.createLinearGradient(0,cy-r,0,cy);
  face.addColorStop(0,'#132338'); face.addColorStop(1,'#0c1526');
  ctx.fillStyle=face; ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI,0); ctx.lineTo(cx,cy); ctx.closePath(); ctx.fill();

  // glass highlight
  const g=ctx.createLinearGradient(0,cy-r,0,cy-r*0.55);
  g.addColorStop(0,'#ffffff26'); g.addColorStop(1,'#ffffff00');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy,r-8,Math.PI,-Math.PI*0.6); ctx.lineTo(cx,cy); ctx.closePath(); ctx.fill();

  ctx.save(); ctx.translate(cx,cy);

  // ticks + numerals OUTSIDE
  for(let i=-50;i<=50;i++){
    const ang=(-90+i*1.8)*Math.PI/180;
    const L=(i%10===0)?28:(i%5===0?16:9);
    const outer=r+10, inner=outer-L;

    ctx.strokeStyle = i===0 ? "#3bd08b" : "#2a4058";
    ctx.lineWidth = i===0 ? 5 : 3;
    ctx.beginPath(); ctx.moveTo(outer*Math.cos(ang),outer*Math.sin(ang));
    ctx.lineTo(inner*Math.cos(ang),inner*Math.sin(ang)); ctx.stroke();

    if(i%10===0 && i!==0){
      ctx.fillStyle="#c2d2e4"; ctx.font="700 18px system-ui";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      const tx=(outer+18)*Math.cos(ang), ty=(outer+18)*Math.sin(ang);
      ctx.fillText(Math.abs(i),tx,ty);
    }
  }

  // in-tune window arc
  ctx.beginPath(); ctx.strokeStyle="#2fe17d"; ctx.lineWidth=14; const ok=6*Math.PI/180;
  ctx.arc(0,0,r-42,-ok,ok); ctx.stroke();

  // inner rim
  ctx.beginPath(); ctx.strokeStyle="#0a1220"; ctx.lineWidth=10; ctx.arc(0,0,r-36,-Math.PI,0); ctx.stroke();

  ctx.restore();
}
function drawNeedle(ok){
  const cx=cssW/2, cy=cssH*0.9, r=cssH*0.84;
  ctx.save(); ctx.translate(cx,cy);
  const ang=(-90+dispAngle)*Math.PI/180; ctx.rotate(ang);

  // needle body
  const grad=ctx.createLinearGradient(0,-r,0,0);
  grad.addColorStop(0, ok ? "#a8f6d5" : "#edf1f7");
  grad.addColorStop(1, ok ? "#2fe17d" : "#bcc5d1");
  ctx.strokeStyle=grad; ctx.lineWidth=5; ctx.lineCap="round";
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,-r+70); ctx.stroke();

  // center hub
  const hub=20, m=ctx.createRadialGradient(0,0,4,0,0,hub);
  m.addColorStop(0,"#f8f8f8"); m.addColorStop(0.5,"#d4d9e1"); m.addColorStop(1,"#8d98ab");
  ctx.fillStyle=m; ctx.beginPath(); ctx.arc(0,0,hub,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle="#1b2a3d"; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,hub,0,Math.PI*2); ctx.stroke();

  ctx.restore();
}
function animate(){ dispAngle += (targAngle-dispAngle)*easing; drawFace(); drawNeedle(inTune); requestAnimationFrame(animate); }
resizeDial(); animate();

/* ===================== AUDIO / PITCH ===================== */
let AC, micNode, analyser, buf, rafId;
let smoothCents=0, detectHoldIdx=null, detectHoldFrames=0, perfectFrames=0;

function ensureAC(){ if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)({latencyHint:"interactive"}); if(AC.state==="suspended") AC.resume(); return AC; }
document.addEventListener("visibilitychange",()=>{ if(AC && AC.state==="suspended") AC.resume(); });

async function startMic(){
  try{
    ensureAC();
    // iOS unlock
    const s=AC.createBufferSource(); s.buffer=AC.createBuffer(1,1,AC.sampleRate); s.connect(AC.destination); s.start(); s.stop();
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    micNode=AC.createMediaStreamSource(stream);
    analyser=AC.createAnalyser(); analyser.fftSize=2048; analyser.smoothingTimeConstant=0.85;
    buf=new Float32Array(analyser.fftSize);
    micNode.connect(analyser);
    els.micState.textContent="ON"; els.live.classList.add('live'); els.micBtn.textContent="Stop Mic"; els.noInput.style.display="none";
    loop();
  }catch(e){ alert("Mic error: "+e.message+"\n• Use HTTPS\n• Allow mic permission\n• Close other apps using the mic"); }
}
function stopMic(){
  if(rafId) cancelAnimationFrame(rafId), rafId=null;
  if(micNode && micNode.mediaStream){ micNode.mediaStream.getTracks().forEach(t=>t.stop()); }
  micNode=null; analyser=null; buf=null;
  els.micState.textContent="OFF"; els.live.classList.remove('live'); els.micBtn.textContent="Start Mic";
  targAngle=0; inTune=false; els.inTune.style.display="none";
  setState("—",""); els.detected.textContent="—"; els.noteBig.textContent="—";
}
function yin(b,sr){
  const thr=0.15, tauMax=Math.floor(sr/50), tauMin=Math.floor(sr/1000), N=b.length;
  const diff=new Float32Array(tauMax), cm=new Float32Array(tauMax); cm[0]=1;
  for(let t=tauMin;t<tauMax;t++){ let s=0; for(let i=0;i<N-t;i++){ const d=b[i]-b[i+t]; s+=d*d } diff[t]=s }
  let run=0,best=1e9,bt=-1;
  for(let t=tauMin;t<tauMax;t++){ run+=diff[t]; cm[t]=diff[t]*t/run; if(t>tauMin && cm[t]<thr && cm[t]<best){ best=cm[t]; bt=t; } }
  if(bt<0) return null;
  const x0=Math.max(1,bt-1), x2=Math.min(cm.length-1,bt+1);
  const s0=cm[x0], s1=cm[bt], s2=cm[x2];
  const tau=bt+(s2-s0)/(2*(2*s1-s2-s0));
  return sr/tau;
}

function nearestStringIdx(freq,a4){
  const set=TUNINGS[els.inst.value]||[];
  if(!set.length) return null;
  let bestIdx=null, bestC=1e9, bestLabel="", pos=-1;
  for(let i=0;i<set.length;i++){
    const idx=parseNote(set[i]); const hz=idxToFreq(idx,a4);
    const c=Math.abs(centsOff(freq,hz));
    if(c<bestC){ bestC=c; bestIdx=idx; bestLabel=`String ${i+1} — ${set[i]}`; pos=i; }
  }
  return {idx:bestIdx,label:bestLabel,pos};
}

function loop(){
  rafId=requestAnimationFrame(loop);
  if(!analyser) return;
  analyser.getFloatTimeDomainData(buf);

  // level / gate
  let sumAbs=0; for(let i=0;i<buf.length;i++) sumAbs+=Math.abs(buf[i]);
  const silent=sumAbs/buf.length<1e-5;
  let rms=0; for(let i=0;i<buf.length;i++) rms+=buf[i]*buf[i]; rms=Math.sqrt(rms/buf.length);
  els.rms.textContent=rms.toFixed(3);
  els.rmsFill.style.width=Math.min(1,rms*5)*100+"%";
  els.noInput.style.display=silent?"inline-block":"none";
  const gate=parseFloat(els.gate.value);
  if(rms<gate || silent){ inTune=false; targAngle+=(0-targAngle)*0.12; setState("—",""); els.inTune.style.display="none"; return; }

  // pitch
  const sr=AC.sampleRate||48000;
  const f=yin(buf,sr);
  if(!f || f<45 || f>1500){ inTune=false; targAngle+=(0-targAngle)*0.12; setState("—",""); els.inTune.style.display="none"; return; }

  const a4=+els.a4.value;
  // auto-detect string
  let targetIdx;
  const set=TUNINGS[els.inst.value]||[];
  if(set.length){
    const near=nearestStringIdx(f,a4);
    if(near){
      if(detectHoldIdx===near.idx) detectHoldFrames++; else { detectHoldIdx=near.idx; detectHoldFrames=1; }
      if(detectHoldFrames>=6){ targetIdx=near.idx; els.detected.textContent=near.label; if(near.pos>-1) els.string.selectedIndex=near.pos; }
    }
  }
  if(!targetIdx){
    targetIdx=(els.string.disabled||!els.string.value)?freqToIdx(f,a4):+els.string.value;
    if(els.string.disabled) els.detected.textContent=nameFromIdx(targetIdx);
  }

  const targetHz=idxToFreq(targetIdx,a4);
  const dc=centsOff(f,targetHz);

  // smooth and map to dial
  smoothCents+=(dc-smoothCents)*0.25;
  const lim=Math.max(-50,Math.min(50,smoothCents));
  targAngle=DIRECTION*lim*1.8;

  // perfect window logic
  const absC=Math.abs(dc);
  if(absC<=PERFECT_THRESHOLD){ perfectFrames++; } else { perfectFrames=0; }
  if(perfectFrames>=PERFECT_HOLD_FRAMES){
    inTune=true; setState("PERFECT (±5¢)","ok"); els.inTune.style.display="block";
  } else if(dc<0){
    inTune=false; setState("TOO LOW","low"); els.inTune.style.display="none";
  } else {
    inTune=false; setState("TOO HIGH","high"); els.inTune.style.display="none";
  }

  // info
  const nearest=freqToIdx(f,a4);
  els.noteBig.textContent=nameFromIdx(targetIdx).replace("♯","#");
  els.freq.textContent=f.toFixed(2);
  els.cents.textContent=(dc>0?"+":"")+dc.toFixed(0);
  els.target.textContent=nameFromIdx(targetIdx);
}

function setState(text,kind){
  els.state.textContent=text;
  els.state.className="state"+(kind?(" "+kind):"");
}

/* ===================== METRONOME ===================== */
class Metro{
  constructor(ac){ this.ac=ac; this.t=null; this.next=0; this.bpm=120; this.p=[1,0,0,0]; }
  set(bpm,sig){ this.bpm=Math.max(20,Math.min(240,bpm)); this.p=this.sig(sig); }
  sig(s){ const [t,b]=s.split("/").map(Number); return b===8?Array.from({length:t},(_,i)=>i%3===0):Array.from({length:t},(_,i)=>i===0); }
  click(acc){
    const t=this.ac.currentTime+0.005, o=this.ac.createOscillator(), g=this.ac.createGain();
    o.type="square"; o.frequency.setValueAtTime(acc?1000:760,t);
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(acc?0.7:0.45,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);
    o.connect(g).connect(this.ac.destination); o.start(t); o.stop(t+0.15);
  }
  start(bpm,sig){ this.set(bpm,sig); if(this.t) return; if(!AC) ensureAC(); if(AC.state==="suspended") AC.resume();
    this.next=AC.currentTime; let i=0; const loop=()=>{ const spb=60/this.bpm;
      while(this.next<AC.currentTime+0.1){ this.click(!!this.p[i%this.p.length]); i++; this.next+=spb; }
      this.t=setTimeout(loop,25); }; loop();
  }
  stop(){ if(this.t){ clearTimeout(this.t); this.t=null; } }
}
let metro=null;
els.metroBtn.addEventListener("click", ()=>{ if(!metro){ ensureAC(); metro=new Metro(AC); }
  if(els.metroBtn.textContent==="Start"){ metro.start(+els.bpm.value||120, els.sig.value); els.metroBtn.textContent="Stop"; }
  else{ metro.stop(); els.metroBtn.textContent="Start"; } });

/* ===================== BUTTONS ===================== */
els.micBtn.addEventListener("click", ()=>{ if(!micNode) startMic(); else stopMic(); });
els.stopAll.addEventListener("click", ()=>{ stopMic(); metro?.stop?.(); els.metroBtn.textContent="Start"; });
</script>
</body>
</html>
